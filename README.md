# Preparation
```
conda create -n deeporacle python=3.9
pip install -r requirements.txt
```


## Install Defects4J
- See: https://github.com/rjust/defects4j
- Install v2.0.0

## Install GrowingBugs
- See: https://github.com/liuhuigmail/GrowingBugRepository
- Install v7.0
- Commit a880ccb, adding 100 new bugs


# Directory Architecture
```text
.
â”œâ”€â”€ data
â”œâ”€â”€ eval
â”‚Â Â  â”œâ”€â”€ rq1.py
â”‚Â Â  â””â”€â”€ rq3.py
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ RQ1
â”œâ”€â”€ RQ2
â”œâ”€â”€ RQ3
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ ablation.py
â”‚Â Â  â”œâ”€â”€ baseline_llm.py
â”‚Â Â  â”œâ”€â”€ exception_judge.py
â”‚Â Â  â”œâ”€â”€ gen_oracle.py
â”‚Â Â  â”œâ”€â”€ gen_prefix_by_llm
â”‚Â Â  â”œâ”€â”€ get_scenario.py
â”‚Â Â  â”œâ”€â”€ __init__.py
â”‚Â Â  â”œâ”€â”€ postprocess.py
â”‚Â Â  â”œâ”€â”€ processing.py
â”‚Â Â  â”œâ”€â”€ __pycache__
â”‚Â Â  â”œâ”€â”€ template
â”‚Â Â  â”œâ”€â”€ test.ipynb
â”‚Â Â  â””â”€â”€ voter.py
â””â”€â”€ structure.txt
```

# Use DeepOracle to Generate oracles 
requires configuring API-KEY (src/.env)
```bash
cd src
# Generate Scenario
python get_scenario.py work_dir
# Generate oracle candidates and vote
python gen_oracle.py work_dir
python voter.py work_dir
# Execute exception Inference 
python exception_judge.py work_dir
```
* work_dir represents the working directory, which should include inputs.csv, meta.csv, context.csv

---

# Reproduction
## RQ1
### Executing oracles generated by different methods
* Datasets need to be prepared before running
* All runtime data and results during the experiment are stored in `data/run_record.tar.gz`
``` bash
# generate oracles using DeepOracle and Baselines
tar -xzvf data/run_record.tar.gz -C data
tar -xzvf RQ1/data/test_framework.tar.gz -C RQ1/data
cd RQ1
# run experiments for rq1_1 and rq1_2
bash run_rq1_2.sh 4 1
```

### Display the comparison results with baselines
* Alternatively, you can directly read our recorded run results from `data/run_record.tar.gz`
* You can execute the following script to view the data statistics results.
``` bash
tar -xzvf data/run_record.tar.gz -C data
cd eval
python rq1.py
```
ðŸ“¦ Structure of `run_record.tar.gz`
``` bash
.
â”œâ”€â”€ bugfound_evo.csv
â”œâ”€â”€ bugfound_llm.csv
â”œâ”€â”€ d4j_evo_prefix
â”œâ”€â”€ d4j_llm_prefix
â”œâ”€â”€ gb_evo_prefix
â””â”€â”€ gb_llm_prefix
```
### Top-level files

* `bugfound_evo.csv` and `bugfound_llm.csv`
These two files summarize the bugs found by different approaches on two types of test prefixes (evosuite-based and LLM-based, respectively).


### Top-level directories
The four directories:
* `d4j_evo_prefix`
* `d4j_llm_prefix`
* `gb_evo_prefix`
* `gb_llm_prefix`

correspond to different datasets (e.g., Defects4J and GrowingBugs) and different types of generated test prefixes (evosuite-based vs. LLM-based).

Each of these directories contains four subdirectories:

* `deeporacle` (our approach)
* `llm_direct` (baseline)
* `toga` (baseline)
* `togll` (baseline)

Each subdirectory represents the results produced by a specific method on the corresponding dataset and prefix type.

### Files inside each method directory

Within each method directory (e.g., deeporacle/), the main files and folders include:
* `context.csv`:
Stores the class-level context of the focal method.

* `inputs.csv`:
Contains the focal method, test prefixes, and related input information used for generation.

* `scenarios.csv`:
Stores the generated test scenarios.

* `test_case_llm_v1.csv`, `test_case_llm_v2.csv`, `test_case_llm_v3.csv`:
Store the complete generated test cases with oracles from three independent runs.

* `*_generated/` (e.g., `togs_generated/`):
Contains various intermediate records produced during test case generation and execution.

* `rq1.csv`:
Stores the execution results of the generated test cases, used for answering RQ1.


## RQ2
Test Scenario Evaluation samples and evaluation results are stored in `RQ2`


## RQ3
### Display the ablation experiment results
All runtime data and results during the experiment are stored in `RQ3/ablation_run_record.tar.gz`.

You can execute the following script to view the data statistics results.
``` bash
tar -xzvf RQ3/ablation_run_record.tar.gz -C RQ3
cd eval
python rq3.py
```

### Manually rerun the ablation experiment 
requires configuring API-KEY (src/.env)

* Without Exception Inference
``` bash
# Generate Scenario
python get_scenario.py work_dir
# Generate oracle candidates and vote
python gen_oracle.py work_dir
python voter.py work_dir
```
* Without Scenario Inference
``` bash
python -m ablation.get_oracle_candidates_no_scenario work_dir
python voter.py work_dir
python -m ablation.get_exception_judgement_no_scenario work_dir
```
* Without Both
``` bash
python -m ablation.get_oracle_candidates_no_scenario work_dir
python voter.py work_dir
```
